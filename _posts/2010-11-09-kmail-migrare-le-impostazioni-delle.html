---
layout: post
title: 'KMail: migrare le impostazioni delle cartelle'
date: '2010-11-09T22:00:00.000+01:00'
author: Luca Ferrari
tags:
- linux
- perl
- kde
- kmail
modified_time: '2010-11-09T22:00:02.535+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-3881954984251567407
blogger_orig_url: http://fluca1978.blogspot.com/2010/11/kmail-migrare-le-impostazioni-delle.html
---

<div style="text-align: justify;">La mia posta elettronica vanta un numero sterminato di cartelle e di filtri che uso per gestire un altrettanto vasto numero di iscrizioni a mailing lists. Una cosa molto gradevole di KMail è che è un client di posta furbo: quando si migra da un computer ad un altro o da una versione all'altra, spostare le cartelle di posta e i file di configurazione è sufficiente per migrare l'intera posta comprensiva di account, regole e filtri.</div><div style="text-align: justify;">Tuttavia KMail non è così furbo da aggiustare anche gli account associati alle cartelle di posta, e quindi a seguito della migrazione un nuovo messaggio creato dentro ad una qualsiasi cartella viene editato con l'account di default. Ovviamente è possibile sistemare manualmente il problema, ma nel mio caso questa soluzione mi avrebbe portato via troppo tempo.&nbsp;</div><div style="text-align: justify;">Ho quindi deciso di studiare come KMail associa le identità degli account alle cartelle e di creare un banale programma che, in modo molto goffo, aggiusti le cose per me.</div><div style="text-align: justify;">KMail memorizza le identità degli account di posta nel file <i>emailidentities</i>, e ogni identità in tale file contiene un valore identificativo univoco come proprietà dal nome <i>uoid</i>. Ogni identità ha quindi una linea del tipo</div><div style="text-align: justify;">uoid = 1234556</div><div style="text-align: justify;">con il valore numerico che cambia a seconda dell'identità. Il primo passo è quindi quello di recuperare lo <i>uoid</i> associato ad un account di posta (nel mio caso non ho account duplicati su varie identità, altrimenti il test dovrebbe essere piu' complesso).</div><div style="text-align: justify;">A questo punto, nel file di configurazione principale di KMail, <i>kmailrc</i>, occorre analizzare ogni sezione di ogni cartella, e infatti in essa si troverà una linea che indica se occorre usare l'identità di default (<i>UseDefaultIdentity = true</i>) e una linea che indica l'identità da usare al suo posto (<i>Identity = uoid</i>). Quindi individuata la sezione corrispondente alla cartella che si vuole manipolare, è sufficiente inserire le due righe di cui sopra specificando l'identità da usare e facendo in modo che l'identità di default risulti disabilitata per tale cartella.</div><div style="text-align: justify;">Si può fare ancora di piu': nel mio caso le cartelle corrispondenti a mailing list sono, con grande fantasia, tutte raggruppate sotto un'unica cartella dal nome <i>Mailing List</i>. Ebbene, <i>kmailrc</i> contiene nel nome della sezione il percorso completo della cartella, incluso il nome del padre della cartella. Quindi nel mio caso, le cartelle da manipolare non devono essere specificate manualmente ma possono essere ricavate automaticamente usando il prefisso <i>Mailing List</i>.</div><div style="text-align: justify;">Di seguito presento lo script Perl che realizza quanto descritto sopra. Il suo utilizzo, da linea di comando, prevede il passaggio di due argomenti: il percorso al file di configurazione principale <i>kmailrc</i> e un indirizzo di posta da usare per ottenere l'identità dell'account. L'output è un file di configurazione differente, denominato <i>kmailrc.new</i> da sostituire, previo controllo, a quello originale.</div><br /><br /><pre>#!/usr/bin/perl<br /><br />open( KMAILRC, "&lt;$ARGV[0]" )       || die("\nCannot open the specified kamilrc file\n$!\n");<br />open( EMAILIDENTITIES, "&lt;$ARGV[1]")|| die("\nCannot open the email identities file\n$!\n");<br />open( NEWCONFIG, "&gt;kmailrc.new" )  || die("\nCannot open the new configuration file\n$!\n");<br /><br /><br />$emailAddress = $ARGV[2];<br />$IDENTITY = undef();<br /><br /># first step: find the identity id<br />while( ($line = <emailidentities>) &amp;&amp; (! defined($IDENTITY) ) ){<br />    chomp( $line );<br />    if( $line =~ /$emailAddress/ ) {<br /> print "\nFound e-mail addrress $line";<br /> while( ($line = <emailidentities>) &amp;&amp; (! defined( $IDENTITY ) ) ){<br />     if( $line =~ /uoid/ ){<br />  $line =~ s/(uoid=)(.*)/$2/;<br />  $IDENTITY = $line;<br />  print "\nFound an identity uoid = $IDENTITY\n";<br />  <br />     }<br /> }<br />    }<br />}<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />$FolderKey = $ARGV[3];<br /><br />while( $line = <kmailrc> ){<br />    chomp( $line );<br /><br />    if( $line =~ /\[Folder-\.$FolderKey/ ){<br /> chomp( $line );<br /> print NEWCONFIG $line , "\n";<br /> print "\nFound folder $line\n";<br /> $doneThisFolder = "";<br /><br /> while( ($innerLine = <kmailrc>) &amp;&amp; (! $doneThisFolder ) ){<br />     chomp( $innerLine );<br /><br />     if ( $innerLine =~ /UseDefaultIdentity/ ){<br />  print NEWCONFIG "UseDefaultIdentity=false\n";<br />  print NEWCONFIG "Identity=$IDENTITY\n";<br />  $doneThisFolder = "true";<br />     }<br />     elsif( $innerLine =~ /Identity/ ){<br />  # print nothing, it has already be printed in the <br />  # UseDefaultIdentity identity<br />     }<br />     else{<br />  print NEWCONFIG $innerLine , "\n";<br />     }<br />     <br /> }<br /><br />    }<br />    else{<br /> print NEWCONFIG $line , "\n";<br />    }<br />    <br />}</kmailrc></kmailrc></emailidentities></emailidentities></pre>