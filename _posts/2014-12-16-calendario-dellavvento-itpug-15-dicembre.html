---
layout: post
title: 'Calendario dell''Avvento ITPUG: 15 Dicembre'
date: '2014-12-16T18:19:00.000+01:00'
author: Luca Ferrari
tags:
- itpug
- calendario avvento
- postgresql
modified_time: '2014-12-17T08:20:07.773+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-7904800853533316701
blogger_orig_url: http://fluca1978.blogspot.com/2014/12/calendario-dellavvento-itpug-15-dicembre.html
---

<div style="text-align: justify;">Io sono sempre stato dell'opinione che i commenti siano anche piu' importanti del codice. Però si sa, i programmatori sono pigri, gli admin pure e i commenti spesso si perdono.<br />Però si può commentare anche un database, e questo potrebbe tornare molto utile. Non parlo dei commenti negli script SQL ( -- e /* */ ), ma del comando <a href="http://www.postgresql.org/docs/current/static/sql-comment.html">COMMENT</a> di PostgreSQL&nbsp; che consente di attaccare una stringa di testo ad un oggetto di database (tabella, colonna, constraint, funzione, ...).<br />&nbsp;</div><div style="text-align: justify;">&nbsp;Per cosa si può usare questa funzionalità? Ad esempio per creare una sorta di versioning del poveraccio: se ogni commento include un numero di versione (generato manualmente o automaticamente) si può capire a che versione un database/tabella è, e quindi si potrebbe intervenire piu' rapidamente per scoprire eventuali anomalie. Ma vediamo COMMENT in pratica:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># COMMENT ON CONSTRAINT imu IS 'no comment!';</span><br /><br />(visto il giorno fatidico!)<br />Piu' seriamente:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /># COMMENT ON TABLE foo IS 'Tabella foo versione [1.1]';</span><br /><br /><br />Ed è tutto! Solo una stringa può essere agganciata ad un oggetto, e quindi ricommentare lo stesso oggetto equivale a sovrascrivere il commento precedente, mentre impostarlo a NULL equivale a rimuoverlo.  I commenti vengono salvati nella tabella <a href="http://www.postgresql.org/docs/current/static/catalog-pg-description.html">pg_description</a>.<br />Da qui a vedere un dump completo di una tabella il passo è breve:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># WITH rel_comments AS (</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT c.relname&nbsp; AS tabella, CASE WHEN d.objsubid = 0 THEN</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">'--tabella--' ELSE '(#' || d.objsubid || ') ' || (SELECT attname FROM</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">pg_attribute a WHERE a.attrelid = c.oid AND a.attnum = d.objsubid )</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END AS colonna, d.description AS commento</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">FROM pg_class c JOIN pg_description d ON d.objoid = c.oid )</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT * FROM rel_comments WHERE tabella = 'test';</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;tabella |&nbsp; &nbsp;colonna&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;commento</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">---------+-------------+------</span></span><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">------------------------</span></span></div><div class="a3s" id=":1df" style="text-align: justify;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; test&nbsp; &nbsp; | --tabella-- | Tabella foo versione [1.1]</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; test&nbsp; &nbsp; | (#1) pk&nbsp; &nbsp;&nbsp; | Prima versione della colonna</span></span><br /><br />Un po' piu' complesso risulta invece aggiornare in append i commenti, a meno di non passare per gli oid. E' comunque possibile creare una funzione che accetti il nome della tabella e della colonna, estragga i dati necessari e faccia UPDATE di pg_description concatenando (o sostituendo) il commento.</div>