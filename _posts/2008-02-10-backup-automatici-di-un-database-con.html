---
layout: post
title: Backup automatici di un database con pg_dump e crontab
date: '2008-02-10T13:41:00.000+01:00'
author: Luca Ferrari
tags:
- linux
- postgresql
modified_time: '2008-02-20T15:07:04.987+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-3660253995524356146
blogger_orig_url: http://fluca1978.blogspot.com/2008/02/backup-automatici-di-un-database-con.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


PostgreSQL mette a disposizione uno strumento molto utile, pg_dump, che consente di effettuare un dump di un database (o di porzioni di esso) su un file di testo. Il file prodotto contiene i comandi SQL per la creazione e ripopolazione del database. E' quindi possibile utilizzare pg_dump per il backup dei propri database, magari utilizzando assieme ad una schedulazione automatica quale quella di crontab.<br /><br />Nel seguito viene presentato un semplice script shell che, basandosi su pg_dump, effettua il backup di un database specifico. In particolare, lo script può funzionare in tre modalità:<br /><ul><li>single (default): effettua il backup del database e ne salva il dump in una directory con nome pari al giorno di backup (es. mer, gio, ven,...). Utile per fare il backup giornaliero del database, con rotazione settimanale.</li><li>dated: effettua il backup del database salvando il dump in un file isolato che include le informazioni relative alla data di backup. Utile per effettuare un <span style="font-style: italic;">checkpoint</span> del database ad una specifica data; il backup non viene mai sovrascritto.</li><li>isolated: simile a single, ma memorizza i dump in una directory specifica per ogni database.</li></ul>In sostanza, supponendo di dover fare il backup del database <span style="font-style: italic;">myDB</span>, e immaginando di voler memorizzare i backup nella directory <span style="font-style: italic;">/backup/postgresql</span> si ottiene il seguente layoyut per la modalità single:<br /><br /><pre>+ /backup<br />+ postgresql/<br />+ lun/<br />  myDB.sql<br />+ mar/<br />  myDB.sql<br />+ mer/<br />  myDB.sql<br />+ gio/<br />  myDB.sql<br />+ ven/<br />  myDB.sql<br />+ sab/<br />  myDB.sql<br />+ dom/<br />  myDB.sql</pre><br /><br />Si noti che ogni backup è contenuto in una cartella relativa al giorno della settimana nel quale è stato effettuato il backup. Nel caso della modalità dated si ottiene invece:<br /><br /><pre>+ /backup<br />+ postgresql/<br /> + myDB/<br />   myDB_01_01_08.sql<br />   myDB_05_01_08.sql</pre><br />Ossia si isola una directory con nome uguale a quello del database che si sta backuppando, e al suo interno si memorizzano file diversi secondo la data di backup (si noti che la data viene  memorizzata nel nome del file). Infine, per il caso isolated si ha che:<br /><br /><pre>+ /backup<br />+ postgresql/<br /> + myDB/<br />   + lun/<br />     myDB.sql<br />   + mar/<br />     myDB.sql<br />   + mer/<br />     myDB.sql<br />   + gio/<br />     myDB.sql<br />   + ven/<br />     myDB.sql<br />   + sab/<br />     myDB.sql<br />   + dom/<br />     myDB.sql</pre><br />ossia simile a quella single, dove però i giorni della settimana sono memorizzati all'interno di una directory specifica per il database.<br /><br /><br />Lo script è il seguente:<br /><br /><pre>#!/bin/bash<br /><br />DATABASE_NAME=$1<br />USERNAME=$2<br />HOST=$3<br />WORKING_DIR=$4<br />RUNNING_MODE=$5<br />PG_DUMP=/usr/lib/postgresql/8.2/bin/pg_dump<br /><br /><br />if [ "$RUNNING_MODE" = "--dated" ]<br />then<br />DATA=`date +'%h_%d_%y'`<br />WORKING_DIR="${WORKING_DIR}"/"${DATABASE_NAME}"<br />OUTFILE="${DATABASE_NAME}_${DATA}.sql"<br />else<br />DATA=`date +'%a'`<br /><br />if [ "$RUNNING_MODE" = "--isolated" ]<br />    then<br />    WORKING_DIR="${WORKING_DIR}"/"${DATABASE_NAME}/${DATA}"<br />    OUTFILE="${DATABASE_NAME}.sql"<br /><br />else<br /># data = giorno della settimana<br />    WORKING_DIR="${WORKING_DIR}"/"${DATA}"<br />    OUTFILE="${DATABASE_NAME}.sql"<br />fi<br /><br />fi<br /><br /><br /># Creo la directory se non esiste<br />if ! test -d "$WORKING_DIR"<br />then<br />mkdir "$WORKING_DIR" > /dev/null 2>&amp;1<br />if [ $? -ne 0 ]<br />    then<br />    echo "Errore nella creazione della directory $WORKING_DIR"<br />    exit<br />fi<br />fi<br /><br /><br /><br /># entro nella directory di lavoro<br />cd "$WORKING_DIR"<br />START_TIME=`date`                # istante di inizio<br /><br /><br /># esecuzione del backup effettivo<br />$PG_DUMP --create --column-inserts -f $OUTFILE --encoding=Latin1 -U $USERNAME -h $HOST  $DATABASE_NAME<br />END_TIME=`date`<br /><br /></pre>Come si può notare lo script prepara anzitutto la directory che deve contenere i file di dump, a seconda della modalità con la quale lo script viene eseguito. Successivamente ci si sposta nella directory relativa e si effettua il backup mediante pg_dump. L'opzione <span style="font-style: italic;">--column-inserts</span> ordina a pg_dump di inserire nel file di dump dei comandi INSERT per la popolazione delle tabelle, al posto del default COPY. Si noti che quest'ultimo è più veloce e consente di ridurre la dimensione del file di dump (che contiene meno caratteri), ma la soluzione con INSERT risulta maggiormente portabile anche fra database differenti.<br /><br />Si noti come lo script accetti i parametri relativi all'host al quale occorre connettersi e con quale username. Solitamente è bene specificare l'utente amministratore per il database, avendo cura di verificare il file <span style="font-style: italic;">pg_hba.conf</span> affinché contenga un'entry che consenta la connessione dall'host dal quale si effettua il backup.<br /><br />Qualora il database richieda una password per l'utente specificato, occorre specificare tale password mediante il file .pgpass, che deve trovarsi nella directory dell'utente che lancia lo script di backup. Il file .pgpass ha la seguente struttura:<br /><br /><span style="font-size:85%;"><span style="font-family:arial;">host:porta:database:utente:password</span></span><br /><br />come ad esempio<br /><br /><span style="font-size:85%;"><span style="font-family:arial;">sede:5432:myDB:luca:L)c(<br />192.168.1.2:5432:postfix:Mailer:$escCTRL</span><br /><br /></span>A questo punto è possibile inserire la schedulazione dello script in cron, con ad esempio delle entry simili alle seguenti:<br /><br /><pre>00 19 * * 5 backup_postgresql.sh   myDB luca     sede /backup/vari/postgres   --dated<br />00 19 * * 1-4 backup_postgresql.sh myDB luca     sede /backup/vari/postgres</pre>Si noti che per cinque giorni la settimana viene fatto il backup a rotazione settimanale (modalità single), mentre una volta alla settimana viene effettuato quello dated. In questo modo si ha un backup per ogni giorno della settimana, e un backup persistente per ogni settimana.