---
layout: post
title: 'Calendario dell''Avvento ITPUG: 22 Dicembre'
date: '2014-12-23T23:26:00.000+01:00'
author: Luca Ferrari
tags:
- itpug
- calendario avvento
- postgresql
modified_time: '2014-12-23T23:26:00.544+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-8089928753506094416
blogger_orig_url: http://fluca1978.blogspot.com/2014/12/calendario-dellavvento-itpug-22-dicembre.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Esiste un <a href="https://github.com/gleu/sqlite_fdw">Foreign Data Wrapper di SQLite</a>.</div><div style="text-align: justify;">Io personalmente non lo uso per scopi specifici, quanto piu' per "collegare" un'istanza PostgreSQL a diversi database del mio desktop KDE. Molte applicazioni KDE infatti si appoggiano a SQLite, e a dire il vero anche altri strumenti come fossil (fossil-scm.org) lo fanno. Lo scopo pe rme è quello solo e puramente di studio dei meccanismi interni di aclune applicazioni, un giorno forse avrò anche bisogno di manipolare in diretta i dati. Ad ogni modo l'uso è abbastanza semplice, quasi banale per chi è abituato ai fdw.</div><br />Faccio un esempio specifico: <a href="https://www.digikam.org/">digikam</a><br /><br /><i>== Passo 1: fare il dump dello schema del database ==</i><br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqlite3 -interactive digikam4.db</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">sqlite&gt; .output digikam.sql</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">sqlite&gt; .schema</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">sqlite&gt; .q</span></span><br /><br /><i>== Passo 2: preparare uno script di migrazione ==</i><br /><br />Mi faccio aiutare qui da Perl (lo script lo riporto in seguito):<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% perl export.pl digikam.sql digikam_server /tmp/digikam4.db &gt;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">export_digikam.sql</span></span><br /><br /><div style="text-align: justify;">così facendo creo un file export_digikam.sql che creerà il server "digikam_server" partendo dal file di dump "digikam.sql". Il nome del file "digikam.db" serve solo per collegare il data wrapper al database SQLite giusto.</div><br /><i>== Passo 3: caricare le tabelle e il foreign data wrapper ==</i><br /><br />Da un promp psql è abbstanza banale accedere via fdw:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">image=# CREATE EXTENSION sqlite_fdw;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">image=# \i ~/Pictures/digikam_export.sql</span></span><br /><br />e tutto è fatto!<br />Ok, vediamo quanta "roba" c'è nel database:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">image=# SELECT count(id) as Foto, sum( filesize ) / (1024 * 1024 *</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">1024) as Gigabytes FROM images;</span></span><br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">foto&nbsp;  | gigabytes</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">------+-----------</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">39491 |       285</span></span><br /><br /><br /><br /><br /><i>===== script perl di conversione ======</i><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#! /usr/bin/perl</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">use v5.10;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">my $IN;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">my $server = $ARGV[ 1 ];</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">my $file   = $ARGV[ 2 ];</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">open $IN, "&lt;", $ARGV[ 0 ] || die "\nImpossibile leggere file dump\n$!";&nbsp;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">say "CREATE SERVER $server FOREIGN DATA WRAPPER sqlite_fdw OPTIONS (database \'$file\');";   while (&lt;$IN&gt;) {</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">if ( /CREATE TABLE (\w+)/ ) {</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; $table = $1;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; $sql = "CREATE FOREIGN TABLE $1 (\n";</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">}</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">elsif ( $table ){</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; chomp;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; s/DATETIME/TIMESTAMP/;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; s/PRIMARY KEY/NOT NULL/;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; s/\(//;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; $sql .= $_ . "\n" unless /(UNIQUE | \)\; ) /xms;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; if ( /[\)\;]/ ){</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; $sql =~ s/,$//;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; $sql .= ") \n\t SERVER $server \n\t OPTIONS (table \'$table\' );\n" ;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; say $sql;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; undef $table;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; undef $sql;</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp; }</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;}</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">}</span></span>