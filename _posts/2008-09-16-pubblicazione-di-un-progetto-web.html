---
layout: post
title: Pubblicazione di un progetto Web gestito tramite SVN
date: '2008-09-16T10:49:00.000+02:00'
author: Luca Ferrari
tags:
- linux
- svn
modified_time: '2008-09-16T11:07:52.317+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-6753769140439631583
blogger_orig_url: http://fluca1978.blogspot.com/2008/09/pubblicazione-di-un-progetto-web.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


SVN è un ottimo software per il versioning dei sorgenti di qualunque tipo. Quando si utilizza però per progetti Web, può essere necessario avere un qualche tipo di deploy automatico. In altre parole si vuole che il ramo dei sorgenti resi pubblici dal server Web sia automaticamente aggiornato ad ogni commit sul repository SVN. La <a href="http://subversion.tigris.org/faq.html#website-auto-update">FAQ di SVN</a> presenta già una soluzione al problema, ma io ne ho messa a punto una leggermente differente che non fa uso di programmi compilati e di suid, ma semplicemente di script shell e di <span style="font-style: italic;">sudo</span>.<br />L'idea è quella di creare un <span style="font-style: italic;">post-commit-hook</span>, ossia un comando da eseguire a seguito di un commit, che effettui l'aggiornamento dell'albero dei sorgenti web. Nello specifico andrà a fare un <span style="font-style: italic;">update</span> dell'albero dei sorgenti web prendendo solo gli ultimi file modificati in fase di commit (ovviamente si ipotizza che il server web sia locale al repository SVN). Il file <span style="font-style: italic;">post-commit</span> della directory <span style="font-style: italic;">hooks</span> del repository SVN deve quindi contenere il seguente codice shell:<br /><br /><pre>REPOSITORY=$1<br />REVISION=$2<br /><br />GREP_CMD=`which grep`<br />SED_CMD=`which sed`<br />ECHO_CMD=`which echo`<br />SU_CMD=`which su`<br />WWW_USER="www-data"<br />SUDO_CMD=`which sudo`<br />DEPLOY_CMD="/usr/local/bin/svnWeb.sh"<br />SVNLOOK_CMD=`which svnlook`<br />TMP_FILE=/tmp/svn.changed<br />WEB_REPOSITORY="myProject"<br /><br /># controllo se il repository include la parte web<br />$ECHO_CMD $REPOSITORY | $GREP_CMD $WEB_REPOSITORY > /dev/null 2>&amp;1<br />if [ $? -eq 0 ]<br />then<br />   # e' il repository web, faccio la pubblicazione automatica<br /><br />   echo  "Pubblicazione web automatica "                   > $TMP_FILE<br />   echo  "per il repository $WEB_REPOSITORY "             >> $TMP_FILE<br />   echo  " (vedere il file post-commit del server svn) "  >> $TMP_FILE<br />   echo  "\nSeguono i dettagli dell'aggiornamento web\n"  >> $TMP_FILE<br /><br />   # mi faccio dire i file che sono cambiati<br />   $SVNLOOK_CMD changed $REPOSITORY | $AWK_CMD '{print $2;}' >> $TMP_FILE<br /><br />   # faccio la pubblicazione diventando un utente apposito tramite<br />   # il comando su, invocato a sua volta tramite sudo. E' importante<br />   # che l'utente con il quale si esegue il comando sudo abbia<br />   # una impostazione di /etc/sudoers che non richiede password, altrimenti<br />   # questo script non verra' eseguito correttamente.<br />   $SUDO_CMD $SU_CMD -c  $DEPLOY_CMD  $WWW_USER  >> $TMP_FILE<br /><br />fi<br /></pre><br />Come si può notare, oltre all'inizializzazione di alcune variabili (si presti attenzione poiché <span style="font-style: italic;">post-commit</span> potrebbe eseguire con un PATH modificato o nullo) si effettua un primo controllo sul tipo di commit, affinché si riferisca al repository/progetto di cui si vuole fare il deployment. Dopodiché si scrive un semplice file di log per tenere traccia delle ultime modifiche effettuate (questo può essere utile da inviare come allegato in una e-mail di notifica del commit). Infine, si effettua un cambio utente (tramite <span style="font-style: italic;">su</span>) all'utente cui appartiene la directory del server web  e si esegue il comando di deploy (<span style="font-style: italic;">DEPLOY_CMD</span>). Tutto questo viene fatto tramite <span style="font-style: italic;">sudo</span>, per evitare che venga richiesta una password per diventare l'utente del server web. Infatti, se nel file di configurazione di sudo (/etc/sudoers) l'utente che effettua il commit è configurato perché non venga richiesta nessuna password, allora egli può diventare prima superutente (con sudo) e da li un utente qualunque (tramite su) senza che nessuna password sia richiesta.<br />Il comando di deploy (DEPLOY_CMD) è uno script che effettua l'update tramite SVN e sistema i permessi della directory del server Web:<br /><br /><pre>#!/bin/bash<br /><br />SRC_DIR=/var/www/myProject<br />SVN_REPOSITORY=file:///sviluppo/svn/myProject/trunk<br />SVN_CMD=`which svn`<br />CHMOD_CMD=`which chmod`<br />CHOWN_CMD=`which chown`<br />WWW_USER="www-data"<br />WWW_GROUP="www-data"<br /><br /><br /><br /># entro nella directory in cui aggiornare l'albero dei sorgenti<br />cd $SRC_DIR || exit 1<br /><br /># effettuo l'aggiornamento dei sorgenti<br />echo "Aggiornamento dell'albero dei sorgenti..."<br /><br />$SVN_CMD update $SVN_REPOSITORY `pwd`<br />echo "fatto <$?>"<br /><br /># cambio i permessi dei file copiati<br />$CHOWN_CMD $WWW_USER:$WWWGROUP `pwd` -Rf<br />$CHMOD_CMD 755 `pwd` -Rf<br /></pre><br />L'utilizzo di un post-commit hook per la pubblicazione del server Web ha comunque alcuni difetti:<br /><ul><li>occorre più tempo per ogni commit, poiché il server Web deve essere aggiornato;</li><li>per testare le modifiche occorre fare dei commit, e quindi si va a fare il commit di codice non proprio stabile. A tal fine è bene inserire uno schema di branching o tagging.<br /></li></ul>