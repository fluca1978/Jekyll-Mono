---
layout: post
title: PostgreSQL fancy uptime
date: '2013-08-27T17:34:00.000+02:00'
author: Luca Ferrari
tags:
- postgresql
modified_time: '2013-08-27T17:34:00.118+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-521038170274005514
blogger_orig_url: http://fluca1978.blogspot.com/2013/08/postgresql-fancy-uptime.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Dalla versione 8.1 PostgreSQL mette a disposizione una funzione interna, <i>pg_postmaster_start_time()</i>, che restituisce il momento di avvio dell'istanza corrente (ossia del postmaster).</div><div style="text-align: justify;">Unendo tale funzione al <i>current_timestamp</i> e' possibile ottenere facilmente il tempo di uptime del server:</div><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># SELECT date_trunc( 'seconds', current_timestamp - pg_postmaster_start_time() );</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">date_trunc </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">------------</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">00:32:37</span></span><br /><br /><div style="text-align: justify;">In questo modo e' possibile ottenere l'intervallo temporale di uptime del server con precisione al secondo.</div><br /><div style="text-align: justify;">Un DBA/Sysadmin che si rispetti dovrebbe sempre controllare con precisione l'uptime del server, ma per chi vuole un uptime un po' piu' "fancy", ho creato una stored procedure, denominata appunto "uptime", che restituisce una stringa di testo con una frase descrittiva del tempo di esecuzione del server, opportunamento arrotondato.</div>Ad esempio:<br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># SELECT uptime();</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">uptime       </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">--------------------</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Almost 35 minutes </span></span><br /><br />E ad esempio, dopo 47 minuti di attivita' la funzione di uptime riporta:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># SELECT uptime();</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">uptime     </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">---------------</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Almost 1 hour</span></span><br /><br /><div style="text-align: justify;">La funzione opera in questo modo:</div><div style="text-align: justify;">1) ottiene l'uptime in modo preciso;</div><div style="text-align: justify;">2) spezza l'uptime nelle sue singole parti (giorni, ore, minute, secondi);</div><div style="text-align: justify;">3) calcola gli arrotondamenti per eccesso/difetto. Ad esempio se sono passati piu' di 30 secondi si incrementa di una unita' il contatore dei minuti e si escludono i secondi; se analogamente sono passati piu' di 45 minuti si incrementa il contatore delle ore e si tralasciano i minuti, e cosi' via;</div><div style="text-align: justify;">4) si decide quali "pezzi" far vedere (anni, giorni, ore, minuti);</div><div style="text-align: justify;">5) si compone una stringa con opportuni separatori lessicali.</div><br /><div style="text-align: justify;">Ovviamente la funzione puo' essere migliorata, e buona parte del tempo speso dalla funzione stessa serve a calcolare cosa far vedere all'utente e con che arrotondamento. Questo a maggiore ragione colloca la funzione in ambito "fancy" e non certo come strumento di precisione per la manutenzione dell'istanza PostgreSQL.</div><br /><br /><div style="text-align: justify;">Ci sono alcuni casi particolari: se il server e' stato avviato da meno di 10 minuti allora viene ritornato il valore speciale 'now' (da non confondere con l'equivalente testo spesso usato in PostgreSQL):</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># SELECT uptime();</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">uptime    </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-------------</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Almost now!</span></span><br /><br /><div style="text-align: justify;">Se si cade nell'intervallo temporale di +10 e -15 minuti i minuti sono mostrati con maggiore precisione presunta, come ad esempio:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># SELECT uptime();</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">uptime          </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-------------------------</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Pretty much 12 minutes </span></span><br /><br />Di seguito il codice sorgente della funzione.<br /><br /><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">CREATE OR REPLACE FUNCTION uptime()</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">RETURNS text</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">AS $BODY$</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DECLARE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_uptime_interval interval;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description     text;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_hours           float;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes         float;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_days            float;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_years           float;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_seconds         float;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">minutes_separator       text;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hours_separator         text;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">days_separator          text;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">BEGIN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_hours       := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_days        := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_years       := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_seconds     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">minutes_separator   := '';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">days_separator      := '';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hours_separator     := '';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description := 'Pretty much ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT date_trunc( 'seconds', current_timestamp - pg_postmaster_start_time() )</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO current_uptime_interval;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT date_part( 'hour', current_uptime_interval )</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO current_hours;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT date_part( 'minutes', current_uptime_interval )</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO current_minutes;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT date_part( 'days', current_uptime_interval )</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO current_days;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT date_part( 'seconds', current_uptime_interval )</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO current_seconds;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_seconds &gt; 30 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_seconds     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes     := current_minutes + 1;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description := 'Almost ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_minutes &gt;= 45 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_hours       := current_hours + 1;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description := 'Almost ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ELSEIF current_minutes &lt;= 10 THEN            current_minutes     := 0;            current_description := 'Almost ';         END IF;          IF current_hours &gt;= 16 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_days        := current_days + 1;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_hours       := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description := 'Almost ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_days &gt;= 300 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_days        := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_hours       := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_minutes     := 0;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_years       := current_years + 1;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">current_description := 'Almost ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-- special case: the server started here!</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_years = 0 </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">AND current_days  = 0 </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">AND current_hours = 0</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">AND current_minutes &lt; 10 THEN            RETURN 'Almost now!';         END IF;            IF current_years &gt; 0 AND current_days &gt; 0 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">days_separator := ' and ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_days &gt; 0 AND current_hours &gt; 0 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">hours_separator := ' and ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">IF current_hours &gt; 0 AND current_minutes &gt; 0 THEN</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">minutes_separator := ' and ';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END IF;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SELECT current_description </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| CASE WHEN current_years = 1 THEN '1 year'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WHEN current_years &gt; 1 THEN current_years || ' years'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ELSE ''</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| days_separator</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| CASE WHEN current_days = 1 THEN '1 day'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WHEN current_days &gt; 1 THEN current_days || ' days'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ELSE ''</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| hours_separator</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| CASE WHEN current_hours = 1 THEN '1 hour'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WHEN current_hours &gt; 1 THEN current_hours || ' hours'</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ELSE ''</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| minutes_separator</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">|| CASE WHEN current_minutes = 1 THEN '1 minute '</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WHEN current_minutes &gt; 1 THEN current_minutes || ' minutes '</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ELSE ''</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INTO   current_description;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">RETURN current_description;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">END;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$BODY$</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">LANGUAGE plpgsql;</span></span>