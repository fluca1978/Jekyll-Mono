---
layout: post
title: 'Sysadmin Panics: script di backup (ma non di recovery!)'
date: '2014-03-01T17:55:00.000+01:00'
author: Luca Ferrari
tags:
- sysadmin panics
modified_time: '2014-03-01T17:55:00.155+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-3635841984952396417
blogger_orig_url: http://fluca1978.blogspot.com/2014/03/sysadmin-panics-script-di-backup-ma-non.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Ogni tanto inciampo ancora in qualche script ben fatto per il backup automatico dei sistemi *nix, e spesso mi torna alla mente quanti script orrendi ho dovuto correggere a tal proposito in passato.</div><div style="text-align: justify;">Due erano gli errori piu' ricorrenti che mi causavano diversi grattacapi:</div><div style="text-align: justify;"></div><div style="text-align: justify;">1) test sbagliati o fallimentari sull'esistenza di backup precedenti;</div><div style="text-align: justify;"></div><div style="text-align: justify;">2) mount errato o multiplo di locazioni di backup remote.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Per quanto riguarda il primo, test sbagliati sull'esistenza di backup precedenti, l'errore era spesso tanto semplice quanto subdolo: lo script presentava uno "slurping" test che non eseguiva il backup in caso di assenza di una copia precedente. In altre parole qualcosa del tipo:</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if [ -f backup.zip ]</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">then</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; mv backup.zip old_backup.zip</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; # fai nuovo backup</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">fi</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Ora in cosa e' fallimentare questo test? Se viene rimosso l'entry che segnala la presenza di un backup l'intero script non esegue. Ok, ma perche' dovrebbe essere rimosso da storage il backup precedente? Perche' ad esempio si e' aggiunto un disco nuovo (vuoto) o perche', in una fase di panico, si e' cancellato tutto il backup pregresso per fare un punto zero.  E lo script di cui sopra puo' fallire silenziosamente facendo trovare il sysadmin di turno in una situazione in cui il backup di fatto non c'e'!</div><div style="text-align: justify;">La soluzione e' ovvia e semplice:</div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if [ -f backup.zip ]</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">then</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; mv backup.zip old_backup.zip</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">fi</span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></div><div style="text-align: justify;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># fai nuovo backup</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Il secondo tipo di problema e' un po' piu' complesso: se il backup deve essere fatto su uno storage esterno e' bene che questo sia montato e smontato quando serve, per evitare contaminazioni dei dati. Il problema e' che spesso questo storage esterno viene condiviso via SMB o NFS, e il primo in particolare consente lo stacking mount ricorsivo, causando qualche problema nello smontaggio. La soluzione anche qui e' semplice ma un po' laboriosa: occorre montare e smontare i volumi testando il valore di ritorno delle chiamate di sistema. Altrimenti si rischia di non smontare un volume o, peggio, di fare il backup su una directory invece che su una share (e magari riempendo tutto il filesystem)!</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">E in generale l'insegnamento spesso dimenticato e' che non si puo' dire che una procedura di backup funzioni fino a quando non si e' fatto almeno un recovery positivamente.</div>