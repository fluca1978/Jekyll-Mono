---
layout: post
title: 'Calendario dell''Avvento ITPUG: 6 Dicembre'
date: '2014-12-06T15:42:00.006+01:00'
author: Luca Ferrari
tags:
- itpug
- calendario avvento
- postgresql
modified_time: '2014-12-06T15:42:50.576+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-2939911010740755972
blogger_orig_url: http://fluca1978.blogspot.com/2014/12/calendario-dellavvento-itpug-6-dicembre.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


Ecco una "piccola" query che dovrebbe dare uno sguardo piu' facilmente leggibile sui lock attualmente presenti nel sistema. Parto da un possibile output della query per meglio far capire:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-[ RECORD 1 ]---+-------------------------</span></span><br /><div class="a3s" id=":1dz"><wbr></wbr><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">------------------------------</span></span><wbr></wbr><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">--------<br />pid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1492<br />locking_summary | RowExclusiveLock GRANTED on table public.listini<br />user_query&nbsp; &nbsp; &nbsp; | insert into listini(prezzo) select generate_series(1,1000000);<br />by&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bsdmag started on 2014-12-05 13:15:02.759257+00 (running)</span></span><br /><br /><div style="text-align: justify;">ovvero si riporta quale processo (pid) ha quali lock (locking_summary) per l'utente (by) che sta eseguendo la query (user_query) a partire dal tempo indicato (by). Altro non Ã¨ che una reinterpretazione del join fra pg_locks e<br />pg_stat_activity. <br /><br />Inserire la query in una vista, denominata <i>verbose_locck</i>, consente di eseguirla piu' facilmente; di seguito la definizione della query/vista:</div><br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">CREATE VIEW verbose_locks<br />AS<br /><br />WITH full_table_name AS<br />(<br />&nbsp; &nbsp;SELECT 'table ' || nsp.nspname || '.' || clz.relname AS name, clz.oid<br />&nbsp; &nbsp;FROM pg_class clz JOIN pg_namespace nsp ON clz.relnamespace = nsp.oid<br />&nbsp; &nbsp;WHERE clz.relkind = 'r'<br />)<br /><br />SELECT<br />l.pid&nbsp; &nbsp;-- process identifier<br />-- locking information<br />, l.mode<br />&nbsp; || CASE WHEN l.granted THEN ' GRANTED'<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSE ' WAITING'<br />&nbsp; &nbsp; &nbsp;END<br />&nbsp; || ' on ' ||<br />&nbsp; CASE WHEN l.locktype = 'relation'<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN (SELECT name<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM full_table_name<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE oid = l.relation )<br />&nbsp; &nbsp; &nbsp; &nbsp;WHEN l.locktype = 'tuple'&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN&nbsp; &nbsp; ' row '<br />&nbsp; &nbsp; &nbsp; &nbsp;WHEN l.locktype = 'transactionid'<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN&nbsp; &nbsp; &nbsp; &nbsp; ' transaction ' || l.transactionid<br />&nbsp; &nbsp; &nbsp; &nbsp;WHEN l.locktype = 'virtualxid'<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN&nbsp; &nbsp; ' virtual transaction ' || l.virtualtransaction<br />&nbsp; &nbsp; &nbsp; &nbsp;ELSE l.locktype<br />&nbsp; END<br />&nbsp; AS locking_summary<br /><br />-- current query launched from the user<br />, a.current_query AS user_query<br />-- username and some other details about the query<br />, a.usename || ' started on ' || a.query_start || CASE WHEN a.waiting<br />THEN ' (waiting) '<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE ' (running) '<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END<br />&nbsp; AS by<br /><br />FROM pg_locks l LEFT JOIN pg_stat_activity a ON l.pid = a.procpid<br />WHERE l.pid &lt;&gt; pg_backend_pid() -- do not show myself</span></span><br /></div>