---
layout: post
title: L'uso del SeqScan
date: '2013-08-20T18:05:00.000+02:00'
author: Luca Ferrari
tags:
- postgresql
modified_time: '2013-08-20T18:05:00.237+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-403672544813993565
blogger_orig_url: http://fluca1978.blogspot.com/2013/08/luso-del-seqscan.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Il <i>sequential scan</i> o scansione sequenziale e' uno dei metodo di accesso ai dati in una tabella che ogni database,</div><div style="text-align: justify;">e conseguentemente PostgreSQL, fornisce. Tale metodo di accesso non e' assolutamente ottimizzato e prevede la lettura "stupida" del contenuto di una tabella in maniera sequenziale, ovvero dalla prima tupla fino all'ultima.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">PostgreSQL non supporta i <i>query hints</i>, ovvero non consente di specificare a livello di query quale indice utilizzare per recuperare le tuple. Tuttavia PostgreSQL fornisce alcuni parametri di configurazione che possono essere configurati a livello di cluster per abilitare o disabilitare alcuni metodi di accesso. Ne consegue che per forzare l'accesso tramite indice ai dati si possono disabilitare gli altri metodi di accesso.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Questo non vale per il <i>sequential scan</i>: tale metodo di accesso e' da considerarsi una sorta di "ultima spiaggia" per l'accesso ai dati. Di conseguenza il <i>sequential scan</i> non puo' essere evitato se non c'e' altro modo di recuperare i dati.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Per meglio comprendere questo concetto si consideri una piccola tabella (ossia con poche tuple) e un indice sulla chiave primaria definita come segue:</div><br /><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# CREATE TABLE foo( pk SERIAL NOT NULL, description TEXT, PRIMARY KEY( pk ) );</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">NOTICE:  CREATE TABLE will create implicit sequence "foo_pk_seq" for serial column "foo.pk"</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "foo_pkey" for table "foo"</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">CREATE TABLE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# INSERT INTO foo( description ) VALUES( 'Test ' || generate_series(1, 100 ) );</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INSERT 0 100</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# ANALYZE foo;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ANALYZE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# SELECT relname, relpages, reltuples FROM pg_class</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">WHERE relname = 'foo' AND relkind = 'r';</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">relname | relpages | reltuples </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">---------+----------+-----------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">foo     |        1 |       100</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(1 row)</span></span><br /><br /><br /><br /><div style="text-align: justify;">Come ci si puo' aspettare, essendo la relazione piuttosto piccola (solo una pagina dati), l'accesso ai dati sara' di tipo sequenziale anche in presenza di una query risolvibile tramite l'indice:</div><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# SHOW enable_seqscan;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">enable_seqscan </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">----------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">on</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(1 row)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# EXPLAIN ANALYZE SELECT * FROM foo WHERE pk = 10;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">QUERY PLAN                                          </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">---------------------------------------------------------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Seq Scan on foo  (cost=0.00..2.25 rows=1 width=11)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(actual time=0.024..0.053 rows=1 loops=1)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Filter: (pk = 10)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Total runtime: 0.097 ms</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(3 rows)</span></span><br /><br /><br /><br /><div style="text-align: justify;">Essendo presente un indice, se si disabilita il <i>sequential scan</i> si ottiene che l'accesso ai dati viene forzatamente fatto tramite il suddetto indice:</div><br /><br /><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# SET enable_seqscan TO off;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">SET</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# SHOW enable_seqscan;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">enable_seqscan </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">----------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">off</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(1 row)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# EXPLAIN ANALYZE SELECT * FROM foo WHERE pk = 10;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">QUERY PLAN                                                   </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">----------------------------------------------------------------------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Index Scan using foo_pkey on foo  (cost=0.00..8.27 rows=1 width=11)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(actual time=0.031..0.034 rows=1 loops=1)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Index Cond: (pk = 10)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Total runtime: 0.086 ms</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(3 rows)</span></span><br /><br /><br /><br /><div style="text-align: justify;">Come si puo' facilmente vedere il costo dell'accesso via indice e' superiore a quello sequenziale, poich√© la relazione e' troppo piccola per trarre giovamento dal caricamento delle pagine di indice.</div><div style="text-align: justify;">Ma cosa succede se l'indice non e' presente? E' sufficiente ripetere l'esperimento senza creare l'indice sulla chiave primaria per verificare il comportamento:</div><br /><br /><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# DROP TABLE foo;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DROP TABLE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# CREATE TABLE foo( pk SERIAL NOT NULL, description TEXT );</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">NOTICE:  CREATE TABLE will create implicit sequence "foo_pk_seq" for serial column "foo.pk"</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">CREATE TABLE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# INSERT INTO foo( description ) VALUES( 'Test ' || generate_series(1, 100 ) );</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">INSERT 0 100</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# ANALYZE foo;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ANALYZE</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# SHOW enable_seqscan;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">enable_seqscan </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">----------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">off</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(1 row)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">demodb=# EXPLAIN ANALYZE SELECT * FROM foo WHERE pk = 10;</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">QUERY PLAN                                                    </span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">-----------------------------------------------------------------------------</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Seq Scan on foo  (cost=10000000000.00..10000000002.25 rows=1 width=11)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(actual time=0.025..0.054 rows=1 loops=1)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Filter: (pk = 10)</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">Total runtime: 0.100 ms</span></span><br /><span style="font-size: xx-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">(3 rows)</span></span><br /><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Come si puo' notare l'accesso ai dati e' ancora di tipo sequenziale, e non potrebbe essere altrimenti visto che non vi sono altri "percorsi" per raggiungere i dati. La cosa interessante pero' e' che il costo di accesso ai dati e' notevolmente piu' grande del caso precedente, e si tratta solo di un costo presunto, visto che quello effettivo e' rimasto invariato.</div><div style="text-align: justify;">L'idea e' quindi quella di aumentare notevolmente il costo presunto di accesso per invogliare l'ottimizzatore a cercare altre strade per l'accesso ai dati.</div><div style="text-align: justify;">Da notare che il costo di accesso sequenziale non viene mutato, di fatto e' il query planner che incrementa il costo presunto quando trova un metodo di accesso disabilitato.</div>