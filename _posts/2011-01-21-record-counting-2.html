---
layout: post
title: Record Counting ^ 2
date: '2011-01-21T22:08:00.000+01:00'
author: Luca Ferrari
tags:
- postgresql
- php
modified_time: '2011-01-21T22:08:00.349+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-8961501548621112186
blogger_orig_url: http://fluca1978.blogspot.com/2011/01/record-counting-2.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Mi sono trovato a dover mettere la mani sui sorgenti di una applicazione PHP che accede ad un database PostgreSQL mediante ADODB, scovando un errore a prima vista di difficile individuazione anche se molto banale. Questo errore oltretutto non e' strettamente correlato ne' a PostgreSQL ne' a PHP, ma e' un semplice esempio di "cattiva programmazione" (o meglio di programmazione "distratta").<br />Il codice in questione doveva inserire un record in una tabella, senza sapere a priori se il record fosse da modificare o da inserire from-scratch; per discriminare le possibilita' il codice effettuava prima una ricerca fra i dati della tabella per vedere quante righe associate ai dati in esame esistevano. Da notare che la selezione implicitamente faceva un conteggio del numero di righe esistenti. Il risultato veniva poi passato ad un metodo di ADODB per il conteggio delle tuple ritornate, quindi qualcosa del tipo:</div><span style="font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;"><br />$query = "SELECT count(id) FROM myTable";<br />$resultSet = $driver-&gt;execute( $query );<br />$rowCount = $resultset-&gt;RecordCount();</span><br /><br /><div style="text-align: justify;">Notato l'errore? Ebbene inizialmente io non me ne sono accorto, ma il problema del pezzo di codice qui sopra e' che la query che viene richiesta al database e' una "count", e su questa si fa il record count nuovamente. Ora il count di count non ritorna un count al quadrato (eh eh) ma sempre 1: la "SELECT count(id)" ritorna una sola tupla monodimensionale con il numero di record, e quindi il record count di una sola tupla ritorna sempre 1, anche se il valore della tupla (e quindi il conteggio effettivo del count) e' 0! Il codice va quindi corretto con qualcosa del tipo:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$query = "SELECT id FROM myTable";</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$resultSet = $driver-&gt;execute( $query );</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$rowCount = $resultset-&gt;RecordCount();</span></span><br /><br />oppure con qualcosa del tipo:<br /><span style="font-size: x-small;"><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$query = "SELECT count(id) AS conteggio FROM myTable";</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$resultSet = $driver-&gt;execute( $query );</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$tuple = $resultset-&gt;GetArray();</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$rowCount = $tuple[0][0];</span></span><br /><br /><br /><div style="text-align: justify;">L'errore e' subdolo poiche' anche leggendo il codice e' chiaro quali siano le intenzioni del programmatore: contare i record presenti. Tuttavia e' il "doppio conteggio" a mascherare l'errore di esecuzione!</div>