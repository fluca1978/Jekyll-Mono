---
layout: post
title: Controllare lo spazio disco di un server
date: '2008-08-01T12:23:00.000+02:00'
author: Luca Ferrari
tags:
- linux
modified_time: '2008-08-01T13:58:45.307+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-5347256277724071131
blogger_orig_url: http://fluca1978.blogspot.com/2008/08/controllare-lo-spazio-disco-di-un.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


Lo script che presento di seguito viene utilizzato in combinazione con cron per il controllo periodico dell'utilizzo dei dischi e delle partizioni di un server. Qualora lo spazio disco superi una soglia percentuale (ad es. il 95%) della sua capacità totale, allora viene inviata una e-mail di notifica.<br />L'idea è quella di usare il comando <span style="font-style: italic;">df</span> per ottenere le informazioni su ogni filesystem in uso nel sistema, e di verificare se la quantità percentuale di spazio disponibile sia inferiore alla soglia. Nel caso lo spazio disponibile sia inferiore alla soglia percentuale fissata, viene visualizzato un messaggio sullo standard output e, tramite <span style="font-style: italic;">tee</span>, salvato in un file. Tale file viene poi inviato via e-mail ai destinatari della notifica.<br /><br /><pre>#!/bin/bash<br /><br />PROGRAM_VERSION=1.0<br /><br /><br />DF_CMD=`which df`<br />GREP_CMD=`which grep`<br />AWK_CMD=`which awk`<br />SED_CMD=`which sed`<br />EXPR_CMD=`which expr`<br />MAIL_CMD=`which mail`<br />MSG_FILE=/tmp/diskSpace.$$<br />HOSTNAME_CMD=`which hostname`<br />DATE_CMD=`which date`<br />BASENAME_CMD=`which basename`<br />RM_CMD=`which rm`<br />BASENAME_CMD=`which basename`<br />TEE_CMD=`which tee`<br />SEND_EMAIL="false"<br /><br /># prelevo la soglia di controllo<br />THRESHOLD=90<br />if [ $# -ge 1 ]<br />then<br />   THRESHOLD=$1<br />   shift             # escludo altri parametri da linea di comando<br />fi<br /><br /><br /># Creazione del file temporaneo per il report.<br />SERVER_NAME=`$HOSTNAME_CMD`<br />PROGRAM_NAME=`$BASENAME_CMD $0`<br />echo "Report sullo stato dei dischi del server $SERVER_NAME"       >  $MSG_FILE<br />echo "generato in data " `$DATE_CMD`                               >> $MSG_FILE<br />echo "dal programma $PROGRAM_NAME versione $PROGRAM_VERSION"       >> $MSG_FILE<br />echo "----------------------------------------------------------"  >> $MSG_FILE<br /><br /><br />OLD_IFS=$IFS<br />IFS=$'\n'<br /><br />for line in `$DF_CMD -Pha`<br />do<br />   FILESYSTEM=`echo $line | $AWK_CMD '{print $1;}'`<br />   BUSY=`echo $line | $AWK_CMD '{print $5;}' | $SED_CMD 's/%//'`<br />   MOUNT_POINT=`echo $line | $AWK_CMD '{print $6;}'`<br /><br />   # controllo che lo spazio sia effettivamente un numero,<br />   # per evitare di controllare la linea di instestazione<br />   # o altre linee non utili<br />   `$EXPR_CMD $BUSY + 0 > /dev/null 2>&amp;1`<br />   if [ $? -eq 0 ]<br />   then<br /><br /> # controllo se questo file system supera la soglia stabilita<br /> if [ $BUSY -ge $THRESHOLD ]<br /> then<br />     echo "Attenzione: partizione $FILESYSTEM ($MOUNT_POINT) occupata al $BUSY% (soglia fissata al $THRESHOLD%)" | $TEE_CMD -a $MSG_FILE<br />     SEND_EMAIL="true"<br /> fi<br />   fi<br />  <br />done<br /><br />IFS=$OLD_IFS<br /><br /># devo inviare per e-mail la notifica?<br />if [ $# -ge 1 ]<br />then<br />   if [ "$SEND_EMAIL" = "true" ]<br />   then<br /> for addressee in $*<br /> do<br />     $MAIL_CMD -s "$SERVER_NAME: partizioni occupate oltre la soglia!" $addressee < $MSG_FILE<br /> done<br />   fi<br />fi<br /><br /># rimozione del file temporaneo<br />$RM_CMD $MSG_FILE<br /></pre>