---
layout: post
title: 'Calendario dell''Avvento ITPUG: 23 Dicembre'
date: '2014-12-23T23:29:00.000+01:00'
author: Luca Ferrari
tags:
- itpug
- calendario avvento
- postgresql
modified_time: '2014-12-23T23:29:00.665+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-6537870478593757857
blogger_orig_url: http://fluca1978.blogspot.com/2014/12/calendario-dellavvento-itpug-23-dicembre_23.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Un'utility interessante che mi sono sempre riproposto di sperimentare è <a href="http://pgcluu.darold.net/">pgCluu</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Pgcluu  viene distribuito con due eseguibili: pgcluu e pgcluu_collectd. Il  secondo è la parte che si preoccupa di collezionare le statistiche e di  archiviarle su file system, in maniera simile a quanto fatto da altri  tool di monitoring (ad esempio flow-tools). Il programma pgcluu è invece  il responsabile di fare il reporting delle statistiche.</div><div style="text-align: justify;">In  default la collezione delle statistiche avviene su due fronti: il  cluster e il sistema, mediante sar. E' comunque possibile disabilitare  l'uso di sar, e in particolare lo switch -h (che svolge la stessa  funzione dell'omonimo di psql) disabilita l'uso di sar.</div><br />Da notare che nonostante gli eseguibili siano due, la pagina di manuale è una sola ed è riferita a pgcluu(1).<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% export STAT_DIR="/tmp/pgcluu_stats_collection";</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% mkdir $STAT_DIR &amp;&amp; pgcluu_collectd -d demodb -h localhost -M 200MB -D -i 10 -U luca --stat-type all $STAT_DIR </span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">LOG: Detach from terminal with pid: 4442</span></span><br /><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Si  è creata una directory dove verranno collezionate le statistiche e si è  lanciato il programma di raccolta dati. Le opzioni usate fanno si che  il processo vada in background (-D), si colleghi al database "demodb"  (-d) con utente "luca" (-U) sulla macchina locale (-h). Per evitare  l'esecuzione incontrollata si fissa una soglia di raccolta dati con  tetto massimo di 200 MB (-M), si abilita la raccolta di tutte le  statistiche (--stat-type) presenti in PostgreSQL (ossia si legge  pg_stats_all) e si vuole che le statistiche siano collezionate ogni 10  secondi (-i).</div><div style="text-align: justify;">Attenzione  all'opzione -D che può risultare subdola: se il database richiede una  password per l'utente il prompt per la password non viene richiesta e  pgcluu_collectd termina subito. Occorre quindi utilizzar eil file  ~/.pgpass per permettere la connessione automatica (come per psql - in  effetti si usa psql per collezionare i dati).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Nella  directory STAT_DIR si troverà un file testuale "sysinfo.txt" che  contiene un dump di svariate informazioni di sistema (spazio dischi,  dmesg, sysctl, ecc.). Altri file comprendono le statistiche di sistema  in formato CSV:</div><br /><br /><br />Ora generando un po' di carico sul database sotto analisi:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">demodb=# CREATE TABLE baz(value int);</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">demodb=# insert into baz select generate_series(1, 1000);</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">demodb=# insert into baz select generate_series(1, 1000000);</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">demodb=# insert into baz select generate_series(1, 1000000);</span></span><br /><br /><br />A questo punto si può generare il report:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% export STAT_OUTPUT_DIR=/tmp/pgcluu_stat_output</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% mkdir $STAT_OUTPUT_DIR &amp;&amp; pgcluu -o $STAT_OUTPUT_DIR -v -S $STAT_DIR</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">...</span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">DEBUG: Inserting menu into all html files.</span></span><br /><br /><div style="text-align: justify;">E  il gioco è fatto: puntando il proprio browser alla directory di output  si avrà accesso alle statistiche collezionate in un modo un po' piu'  user-friendly.</div><div style="text-align: justify;">Da notare  che il manuale di pgcluu indica di terminare esplicitamente il demone di  raccolta statistiche prima di generare il report, ma io ho provato a  farlo anche senza fermarlo e tutto pare funzionare ugualmente. Unica  pecca: non si possono generare i report sovrascrivendoli di volta in  volta, perché pgcluu si rifiuta. Ne consegue che per eseguire il tutto  in formato schedulato occorre prevedere lo svuotamento della directory  di output o almeno un qualche modo di rotazione.</div><br />Ah, ultima cosa:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% file `which pgcluu`                                   </span></span><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">/usr/local/bin/pgcluu: Perl script, UTF-8 Unicode text executable</span></span><br /><br />