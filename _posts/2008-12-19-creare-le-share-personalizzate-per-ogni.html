---
layout: post
title: Creare le share personalizzate per ogni utente in Samba (con LDAP)
date: '2008-12-19T08:24:00.000+01:00'
author: Luca Ferrari
tags:
- linux
modified_time: '2008-12-19T08:30:20.457+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-9214854901084370895
blogger_orig_url: http://fluca1978.blogspot.com/2008/12/creare-le-share-personalizzate-per-ogni.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


Invece che utilizzare la classica share <span style="font-style: italic;">homes</span> di Samba, ho installato su un server una condivisione personalizzata chiamata <span style="font-style: italic;">MyDoc</span>, che deve essere esclusiva di ogni utente. Per fare questo occorre che la share punti sempre ad una cartella di proprietà esclusiva dell'utente che ha effettuato il login, cosa abbastanza semplice da realizzare tramite le variabili messe a disposizione da Samba, nel caso specifico %U (utente di login):<br /><br />[MYDOC_SMB]<br />        comment           = Cartella documenti personalizzati per utenti<br /><span style="font-weight: bold;">        path                   = /mnt/samba/mydoc_smb/%U</span><br />        browsable         = yes<br />        available            = yes<br />        writable             = yes<br />        printable           = no<br />        copy                   = perm_template<br /><span style="font-weight: bold;">        valid users         = %U</span><br /><br />A questo punto occorre però creare le cartelle di ogni singolo utente, che devono avere come nome il relativo login, e assegnare i diritti a tutte le cartelle in modo che siano di proprietà esclusiva dell'utente stesso. Su un sistema con OpenLDAP è possibile eseguire il seguente script per ottenere lo scopo:<br /><br /><pre>#!/bin/bash<br /><br />SEARCH_CMD=`which ldapsearch`<br />SEARCH_OPTIONS=" -x uid "<br /><br />GREP_CMD=`which grep`<br />GREP_OPTIONS=" uid:"<br />AWK_CMD=`which awk`<br />AWK_OPTIONS="'{print \$2;}' "<br /><br />EVAL_CMD="eval"<br /><br />MKDIR_CMD=`which mkdir`<br />MKDIR_OPTIONS=" -p "<br /><br />MYDOC_ROOT="/mnt/samba/mydoc_smb"<br /><br />CHOWN_CMD=`which chown`<br />CHMOD_CMD=`which chmod`<br />CHMOD_OPTIONS=" 777 "<br /><br />SUCCESSES=0<br />FAILURES=0<br /><br /><br />for utente in `$EVAL_CMD "$SEARCH_CMD $SEARCH_OPTIONS | $GREP_CMD $GREP_OPTIONS | $AWK_CMD $AWK_OPTIONS" `<br />do<br /><br />   # devo ottenere il gruppo di questo utente<br />   SEARCH_OPTIONS_2=" -x \"(&amp;(objectClass=posixGroup)(memberUid=$utente))\" "<br />   GREP_OPTIONS_2=" cn: "<br /><br />   echo -en "Processo utente <$utente>..."<br />   dstDir=${MYDOC_ROOT}/${utente}<br />   $MKDIR_CMD $MKDIR_OPTIONS $dstDir > /dev/null 2>&amp;1<br />  <br />   if [ $? -eq 0 ]<br />   then<br /> echo -en "ok\n"<br /><br /> # devo cambiare il proprietario della directory. Siccome la directory potrebbe<br /> # contenere piu' gruppi, devo ciclare su ognuno e assegno i permessi dell'ultimo gruppo.<br /><br /> for gruppo in `$EVAL_CMD "$SEARCH_CMD $SEARCH_OPTIONS_2 | $GREP_CMD $GREP_OPTIONS_2 | $AWK_CMD $AWK_OPTIONS" `<br /> do<br />     $CHOWN_CMD $utente:$gruppo $dstDir > /dev/null 2>&amp;1<br /> done<br /><br /> $CHMOD_CMD $CHMOD_OPTIONS $dstDir > /dev/null 2>&amp;1<br /><br /> SUCCESSES=$(( SUCCESSES  + 1 ))<br />   else<br /> echo -en "KO\n"<br /> FAILURES=$(( FAILURES + 1 ))<br />   fi<br />  <br />done<br /><br /><br />echo -en "\n\n\nFinito:\n\t $SUCCESSES processati correttamente,\n\t $FAILURES falliti\n"</pre><br />In sostanza tramite ldapsearch si va a cercare ogni utente nel sistema, dopdoiché si effettua una ricerca per trovare i gruppi a cui questo utente appartiene. Siccome un utente può appartenere a più gruppi, come scelta implementativa si tiene valido l'ultimo gruppo trovato. Viene creata la directory e vengono impostati i permessi e il proprietario della directory stessa.