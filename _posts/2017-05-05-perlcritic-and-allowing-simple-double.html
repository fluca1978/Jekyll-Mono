---
layout: post
title: perlcritic and allowing simple double sigils dereferencing
date: '2017-05-05T18:31:00.001+02:00'
author: Luca Ferrari
tags:
- perl
- planet-perl-ironman
modified_time: '2017-05-05T18:31:15.195+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-8210305676499344567
blogger_orig_url: http://fluca1978.blogspot.com/2017/05/perlcritic-and-allowing-simple-double.html
---

I found out, while not searching for it, an interesting policy for <a href="http://search.cpan.org/perldoc?Perl%253A%253ACritic">Perl::Critic</a><br />named <a href="http://search.cpan.org/~xenu/Perl-Critic-Policy-References-ProhibitComplexDoubleSigils-0.2/lib/Perl/Critic/Policy/References/ProhibitComplexDoubleSigils.pm">Perl::Critic::Policy::References::ProhibitComplexDoubleSigils</a>. The idea is quite simple and I find myself agreeing with it:<br />when dereferencing a reference you can omit braces; while this is often not a good habit (because it can become<br />quite difficult to read a complex reference), it can work out on simpler cases:<br /><br /><br /><div class="org-src-container"><br /><pre class="src src-perl">#!env perl<br />use v5.20;<br /><br />my %hash = (<br />    key1 =&gt; "value1"<br />    , key2 =&gt; "value2"<br />    , key3 =&gt; "value3"<br />    );<br /><br />my $hash_ref = \%hash;<br /><br />while ( my ( $k, $v ) = each %$hash_ref ){<br />    say "$k --&gt; $v";<br />}<br /></pre></div><br />In the above code it is quite simple to understand that <code>@$hash_ref</code> refers to the whole hash without the need to use<br />the braces around.<br /><br /><br />I recognize the advantages of using the braces as:<br /><br /><ul class="org-ul"><li>a good habit;<br /></li><li>a way to do a good refactoring in the case the reference points to a multidimensional structure.<br /></li></ul><br />Anyway simple idioms should stay simple and so should the checkers manage them.<br />If I run <code>perlcritic</code> against the above piece of code, the <a href="http://search.cpan.org/perldoc?Perl%253A%253ACritic%253A%253APolicy%253A%253AReferences%253A%253AProhibitDoubleSigils">Perl::Critic::Policy::References::ProhibitDoubleSigils</a><br />will report<br /><br /><br /><pre class="example">% perlcritic --single-policy=ProhibitDoubleSigils p.pl<br />Double-sigil dereference at line 12, column 30.  See page 228 of PBP.  (Severity: 2)<br /></pre><br />Now, using the above mentioned <a href="http://search.cpan.org/~xenu/Perl-Critic-Policy-References-ProhibitComplexDoubleSigils-0.2/lib/Perl/Critic/Policy/References/ProhibitComplexDoubleSigils.pm">Perl::Critic::Policy::References::ProhibitComplexDoubleSigils</a> the result becomes:<br /><br /><br /><pre class="example">% perlcritic --single-policy=ProhibitComplexDoubleSigils p.pl<br />p.pl source OK<br /></pre><br />Ok, let's refactor the program and transform the <i>plain</i> hash in a multidimensional one:<br /><br /><br /><br /><div class="org-src-container"><br /><pre class="src src-perl">#!env perl<br />use v5.20;<br /><br />my %hash = (<br />    key1 =&gt; "value1"<br />    , key2 =&gt; "value2"<br />    , key3 =&gt; "value3"<br />    );<br /><br />my %outer_hash = ( config1 =&gt; \%hash );<br />my $hash_ref = \%outer_hash;<br /><br />while ( my ( $k, $v ) = each %{ $hash_ref-&gt;{config1} } ){<br />    say "$k --&gt; $v";<br />}<br /></pre></div><br />The above part is the right way of dereferencing the reference to the inner hash, and it does use curly braces<br />and makes <code>Perl::Critic</code>, both policies,  not complaining at all.<br /><br /><br />If, instead, we pretend to use double sigils (that is removing the arrow operator) the code becomes:<br /><br /><br /><div class="org-src-container"><br /><pre class="src src-perl">#!env perl<br />use v5.20;<br /><br />my %hash = (<br />    key1 =&gt; "value1"<br />    , key2 =&gt; "value2"<br />    , key3 =&gt; "value3"<br />    );<br /><br />my %outer_hash = ( config1 =&gt; \%hash );<br />my $hash_ref = \%outer_hash;<br /><br />while ( my ( $k, $v ) = each %{ $$hash_ref{config1} } ){<br />    say "$k --&gt; $v";<br />}<br /></pre></div><br />and of course both policies complain about:<br /><br /><br /><pre class="example">% perlcritic --single-policy=ProhibitDoubleSigils p.pl<br />Double-sigil dereference at line 13, column 33.  See page 228 of PBP.  (Severity: 2)<br /><br />% perlcritic --single-policy=ProhibitComplexDoubleSigils p.pl<br />Complex double-sigil dereferences at line 13, column 33.  Found complex double-sigil dereference without curly braces.  (Severity: 2)<br /></pre><br /><br />Something similar happens when you try to extract a single scalar value from the nested hash:<br /><br /><br /><div class="org-src-container"><br /><pre class="src src-perl">...<br /># line 20<br />my $k1 = $$hash_ref{ config1 }-&gt;{ key1 };<br />say "key1 is $k1";<br /><br /># line 23<br />$k1 = $hash_ref-&gt;{ config1 }-&gt;{ key1 };<br />say "key1 is $k1";<br /></pre></div><br />both the above instructions place the correct value into the <code>$k1</code> variable, and the policies both complain about the first line<br />(the one with the <code>$$</code>):<br /><br /><br /><pre class="example">% perlcritic --single-policy=ProhibitDoubleSigils p.pl<br />Double-sigil dereference at line 20, column 10.  See page 228 of PBP.  (Severity: 2)<br /><br />% perlcritic --single-policy=ProhibitDoubleComplexSigils p.pl<br />The value for the global "single-policy" option ("ProhibitDoubleComplexSigils") did not match any policies (in combination with other policy restrictions).<br /></pre><br /><br />Summing up the idea is to allow <span class="underline"><i>double sigils</i> only when you are dereferencing a single level, not for complex data structures</span>.<br />