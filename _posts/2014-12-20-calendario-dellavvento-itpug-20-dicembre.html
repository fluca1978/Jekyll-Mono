---
layout: post
title: 'Calendario dell''Avvento ITPUG: 20 Dicembre'
date: '2014-12-20T09:00:00.000+01:00'
author: Luca Ferrari
tags:
- itpug
- calendario avvento
- postgresql
modified_time: '2014-12-26T21:13:13.399+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-6523171177247019280
blogger_orig_url: http://fluca1978.blogspot.com/2014/12/calendario-dellavvento-itpug-20-dicembre.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">Vorrei introdurre una utility con la quale sto spendendo un po' di tempo  e che, anche se non direttamente collegata a PostgreSQL, può  semplificare la gestione di un database: <a href="http://sqitch.org/">sqitch</a>.<br />Sqitch  funziona con molti database, fra i quali ovviamente PostgreSQL,  producendo degli script sql che vengono usati per fare il  deploy/aggiornamento/test di un database.<br />Sqitch concettualmente funziona un po' come un repository Git/hg:</div><ul style="text-align: justify;"><li>si installa uno schema "sqitch" nel database sotto controllo;</li><li>si usa questo schema per memorizzare le modifiche effettuate e "firmate" con un hash crittografico</li></ul>Il  tutto è trasparente all'utente, che usa il solo comando "sqitch" un po'  come si usa git (e molti comandi e il loro output sono simili, come ad  esempio log, status, add).<br />Attenzione però che sqitch non sostituisce  un sistema di controllo delle versioni, quindi è buona norma usare  sqitch tenendo comunque gli script SQL sotto controllo delle versioni.<br /><br />Ecco un rapidissimo esempio per la generazione di due tabelle in un database (demodb) esistente.<br /><br /><ul><li>crare un nuovo progetto e definire il database</li></ul><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">% sqitch --engine pg init itpug<br />% sqitch target add itpug db:pg://luca:pwd@localhost/demodb</span></span><br />così  facendo si crea un progetto "itpug" e si definisce che quando ci si  riferisce al database "itpug" si punta in realtà a demodb.<br /><br /><ul><li>si aggiunge lo script per la prima tabella</li></ul><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqitch add authors -m "Tabella autori" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Created deploy/authors.sql<br />Created revert/authors.sql<br />Created verify/authors.sql<br />Added "authors" to sqitch.plan<br />% echo "CREATE TABLE authors( pk serial NOT NULL, name text NOT NULL, primary key(pk));" &gt; deploy/authors.sql<br />% echo "DROP TABLE authors CASCADE;" &gt; revert/authors.sql</span></span><br /><br />così facendo sqitch crea tre script sql (vuoti) per il deploy, l'undeploy e la verifica (qui lasciato vuoto).<br /><br /><ul><li>si crea una tabella con dipendenza dalla precedente, così da informare  sqitch in che ordine le modifiche al database vanno applicate</li></ul><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqitch add posts --requires authors -m "Tabella dei post" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Created deploy/posts.sql<br />Created revert/posts.sql<br />Created verify/posts.sql<br />Added "posts [authors]" to sqitch.plan<br />%  echo "CREATE TABLE posts( pk serial NOT NULL, content text , authors_pk  integer, primary key(pk), foreign key(authors_pk) references  authors(pk) );" &gt; deploy/posts.sql<br />% echo "DROP TABLE posts;" &gt; revert/posts.sql</span></span><br /><br /><ul><li>deploy del database, e si nota come sqitch si colleghi a demodb per creare le tabelle nel giusto ordine.</li></ul><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqitch deploy itpug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Adding registry tables to itpug<br />Deploying changes to itpug<br />&nbsp;  + authors .. psql:deploy/authors.sql:1: NOTICE: &nbsp;CREATE TABLE will  create implicit sequence "authors_pk_seq" for serial column "authors.pk"<br />psql:deploy/authors.sql:1: NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "authors_pkey" for table "authors"<br />ok<br />&nbsp;  + posts .... psql:deploy/posts.sql:9: NOTICE: &nbsp;CREATE TABLE will create  implicit sequence "posts_pk_seq" for serial column "posts.pk"<br />psql:deploy/posts.sql:9: NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "posts_pkey" for table "posts"<br />ok</span></span><br /><br />Da  qui in avanti si può usare "log" o "status" per sapere in che stato ci  si trova, se ci sono script non ancora inviati al server, ecc.<br />Occorre  però specificare sempre a quale database si fa riferimento (che qui è  stato denominato itpug per comodità). Se ad esempio eseguiamo status fra  due deploy si avrebbe:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqitch status itpug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /># On database itpug<br /># Project: &nbsp;itpug<br /># Change: &nbsp; 173fb5f9cf9f5048e5b2baf6e6699984b4fdb9fe<br /># Name: &nbsp; &nbsp; authors<br /># By: &nbsp; &nbsp; &nbsp; Luca Ferrari,,,<br />#<br />Undeployed change:<br />&nbsp; * posts</span></span><br /><br /><br />notare come l'output sia simile a quello di un rcs distribuito, anche se qui git/hg/bzr non sono nemmeno stati toccati.<br /><br /><br />Ultimissima  cosa: gli script crewti da sqitch non sono "vuoti" ma contengono&nbsp; informazioni su come gestire le dipendenze. Di conseguenza,  sovrascrivere tali script come ho fatto nel passo 3 è sbagliato. Meglio  quindi editarli nel proprio editor preferito. Per meglio comprendere,  consideriamo di aggiungere un'altra tabella con la dipendenza dalle  altre due:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">% sqitch add statistics --requires authors --requires posts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Created deploy/statistics.sql<br />Created revert/statistics.sql<br />Created verify/statistics.sql<br />Added "statistics [authors posts]" to sqitch.plan<br /><br />% cat deploy/statistics.sql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />-- Deploy statistics<br />-- requires: authors<br />-- requires: posts<br /><br />BEGIN;<br /><br />-- XXX Add DDLs here.<br /><br />COMMIT;</span></span><br /><br />Ecco quindi che quei commenti sql all'inizio del file indicano a sqitch come procedere.<br /><br />Se si vuole esplorare come sqitch gestisce il database e la sua storia si può partire dalla tabella sqitch.changes.