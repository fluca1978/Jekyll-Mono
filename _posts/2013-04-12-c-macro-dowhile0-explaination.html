---
layout: post
title: 'C macro: do..while(0) explaination'
date: '2013-04-12T17:57:00.000+02:00'
author: Luca Ferrari
tags:
- c
- programmazione
modified_time: '2013-04-12T17:57:00.039+02:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-57921931408482609
blogger_orig_url: http://fluca1978.blogspot.com/2013/04/c-macro-dowhile0-explaination.html

permalink: /:year/:month/:day/:title.html
---


<h1>~</h1>


<div style="text-align: justify;">C macros are a very powerful way to make the code readable without having to define a lot of functions in the code. One important aspect of the macros is that they can have arguments, much like an ordinary function, and therefore using a macro can be totally like a function invocation. For instance, in the following piece of code it is almost impossible to say if <i>DO_SOMETHING</i> is a function or a macro, except the convention that macro names are all uppercase:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if( must_work )</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp; DO_SOMETHING( "I'm working hard!" );</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">else</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp; printf( "I'm not working" );</span></span><br /><br /><div style="text-align: justify;">Now assume that <i>DO_SOMETHING</i> is a macro and has the following definition:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#define DO_SOMETHING( msg ) do{ \</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; if( debug_level &gt; 0 )   \</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( msg );      \        </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; } while( 0 )</span></span><br /><br /><div style="text-align: justify;">The above macro simply prints the specified message to standard output if the debug level is higher than zero. </div><div style="text-align: justify;">So what are the differences between a macro that accepts parameters and an ordinary function? The first difference should be evident from the above example: the argument "<i>msg</i>" does not have a type, and therefore the macro must be handled with correct arguments.</div><div style="text-align: justify;">A second difference is the presence of the <i>do{ } while( 0 )</i> statement that surrounds the macro itself: first of all note that there is no semicolon at the end of the do..while statement so that the semicolon at the end of the whole macro is used. In other words the macro expands from:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DO_SOMETHING( "BLAH!" );</span></span><br /><br />to<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">do{ </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;if( debug_level &gt; 0 )   </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp; printf( msg );  </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">} while( 0 );</span></span><br /><br /><div style="text-align: justify;">But why is the do..while needed at all? Does not suffice to use a couple of brackets {..} to surround the macro code? Well, they do suffice, but there is a side effect in using the brackets: the semicolon will cause the breaking of the statement that contains the macro itself.</div><div style="text-align: justify;">To better explain the above, assume the macro is defined without the do..while and therefore appears as follows:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#define DO_SOMETHING( msg )   { \</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; if( debug_level &gt; 0 )   \</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; printf( msg );      \        </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">}</span></span><br /><br /><div style="text-align: justify;">and place it into the code that calls it, that is then expanded it in the following:</div><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></span></span><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if( must_work )</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; /* DO_SOMETHING( "I'm working hard!" ); */</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; { </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; if( debug_level &gt; 0 )   </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( msg );      </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; };</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">else</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; printf( "I'm not working" );</span></span><br /><br />and that does not compile! The reason is that the semicolon before the else statement causes the if to stop (in other words it is a null instruction after the if closes) and the else cannot be "attached" to the if.<br /><div style="text-align: justify;">Therefore, having the do..while allows the caller to place a semicolon without worrying about the statement that (could) wrap the macro itself. In fact, using the do..while the above macro expands to the following working code:</div><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if( must_work )</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; /* DO_SOMETHING( "I'm working hard!" ); */</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; do { </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp; if( debug_level &gt; 0 )   </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp;&nbsp; printf( msg );      </span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; } while( 0 );</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">else</span></span><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp; printf( "I'm not working" );</span></span><br /><br />that is legal!