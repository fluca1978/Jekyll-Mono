---
layout: post
title: 'Importazioni immagini in PostgreSQL: un semplice script shell'
date: '2008-10-30T07:41:00.001+01:00'
author: Luca Ferrari
tags:
- linux
- postgresql
modified_time: '2008-10-30T07:47:37.740+01:00'
blogger_id: tag:blogger.com,1999:blog-1836481905487384887.post-2218966329159061541
blogger_orig_url: http://fluca1978.blogspot.com/2008/10/importazioni-immagini-in-postgresql-un.html
---

Qualche giorno fa mi sono trovato a dover inserire una serie di immagini di persone in un database aziendale, ovviamente facendo corrispondere ciascuna persona alla propria immagine. Siccome il software che sto sviluppando non permette (ancora) di associare ad una persona la propria immagine, mentre consente di visualizzarla, ho deciso di caricare le immagini da linea di comando. Il problema era come mappare ogni immagine con la relativa persona. Purtroppo le immagini erano tutte nominate nella forma <span style="font-style: italic;">nome_cognome</span>, e quindi l'unica strada era quella di sfruttare i relativi dati nel database. Ovviamente questo rischia di creare problemi in casi di omonimia, ma dopotutto è più rapido correggere alcune immagini sbagliate che inserirle una per una a mano!<br />Ho quindi creato il seguente script shell che fa il lavoro sporco:<br /><br /><pre>#!/bin/bash<br /><br />SQL_FILE="immagini.sql"<br />echo "BEGIN;" > $SQL_FILE<br /><br />for img in *.tif<br />do<br />   echo "\t==== Processo immagine $img ==="<br />   NAME=`basename $img .tif`<br />   NAME=`echo $NAME | sed 's/_N//;'`<br />   NAME=`echo $NAME | sed 's/_B//;'`<br />   NAME=`echo $NAME | sed 's/_[1-9]//;'`<br />   NAME=`echo $NAME | tr [:upper:] [:lower:]`<br /><br />   echo "=> $NAME"<br />   FILE_PNG=$NAME.png<br />   FILE_PNG_1=$NAME_1.png<br /><br />   # conversione immagine<br />   if [ ! -f $FILE_PNG ]<br />   then<br /> convert $img -quality 100  $FILE_PNG_1<br /> convert $FILE_PNG_1 -resize 30% $FILE_PNG<br />   fi<br /><br />   # estraggo nome e cognome<br />   sql_surname=`echo $NAME | awk -F_ '{print $1;}'`<br />   if [ -z "$sql_surname" ]<br />   then<br /> sql_surname="XXX"<br />   fi<br /><br />   sql_name=`echo $NAME | awk -F_ '{print $2;}'`<br />   if [ -z "$sql_name" ]<br />   then<br /> sql_name="YYY"<br />   fi<br />  <br />   CURRENT_DIR=`pwd`<br /><br />   echo -en "UPDATE person SET image = lo_import('$CURRENT_DIR/$FILE_PNG') WHERE " >> $SQL_FILE<br />   echo -en " (lower(name)='$sql_name' AND lower(surname)='$sql_surname') " >> $SQL_FILE<br />   echo -en " OR "                                        >> $SQL_FILE<br />   echo -en " (lower(surname)='$sql_surname' AND (SELECT COUNT(surname) FROM person WHERE lower(surname)='$sql_surname') = 1 )" >> $SQL_FILE<br />   echo ";" >> $SQL_FILE<br />  <br />done<br /><br /><br />echo -en "\n\nCOMMIT;\n" >> $SQL_FILE<br /></pre><br />Come si può notare prima faccio un po' di pulizia sul nome del file (le immagini erano tutte .tif) e ottengo la stringa <span style="font-style: italic;">nome_cognome</span>, e procedo ad una conversione nel formato richiesto dalla mia applicazione (<span style="font-style: italic;">png</span>). Successivamente estraggo i singoli pezzi (nome e cognome) e costruisco una stringa di comando SQL per l'update di un campo blob (<span style="font-style: italic;">image</span>) della tabella corrispondente (<span style="font-style: italic;">person</span>). La query SQL effettua un update dove trova corrispondenza di nome e cognome o dove trova anche solo il cognome (a patto che ve ne sia solo uno). Tutte le query SQL vengono salvate in un file che viene poi lanciato da un terminale <span style="font-style: italic;">psql</span>. Da notare che tutti gli inserimenti avvengono all'interno di una transazione, per evitare problemi di incoerenza (o si caricano tutte le immagini o nessuna).